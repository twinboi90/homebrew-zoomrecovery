name: "Setup Homebrew Zoomrecovery"
description: "Installs Homebrew (if missing), taps a Homebrew tap, installs the Zoomrecovery formula, and persists environment variables"
inputs:
  tap:
    description: "Homebrew tap to add (owner/repo)"
    default: "twinboi90/zoomrecovery"
  package:
    description: "The Homebrew formula to install (default: zoomrecovery)"
    default: "zoomrecovery"
runs:
  using: "composite"
  steps:
    - name: Ensure Homebrew present (install if missing)
      shell: bash
      run: |
        set -euo pipefail
        echo "Checking for brew..."
        if command -v brew >/dev/null 2>&1; then
          echo "brew found: $(brew --version | head -n1)"
        else
          echo "brew not found. Installing Homebrew (NONINTERACTIVE=1)..."
          export NONINTERACTIVE=1
          /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
          echo "Homebrew install attempted"
        fi

    - name: Discover Homebrew prefix
      id: discover_prefix
      shell: bash
      run: |
        set -euo pipefail
        BREW_PREFIX=""
        if command -v brew >/dev/null 2>&1; then
          BREW_PREFIX=$(brew --prefix 2>/dev/null || true)
        fi
        # common fallbacks
        for p in "/home/linuxbrew/.linuxbrew" "/opt/homebrew" "/usr/local"; do
          if [ -z "${BREW_PREFIX}" ] && [ -d "${p}" ]; then
            BREW_PREFIX="${p}"
          fi
        done
        echo "brew_prefix=${BREW_PREFIX}" >> "$GITHUB_OUTPUT"
        echo "Detected brew prefix: ${BREW_PREFIX}"

    - name: Tap repository
      shell: bash
      run: |
        set -euo pipefail
        TAP="${{ inputs.tap }}"
        echo "Tapping $TAP (idempotent)..."
        if brew tap | grep -q "^${TAP}$"; then
          echo "Tap $TAP already present"
        else
          brew tap "$TAP" || true
        fi

    - name: Install formula
      shell: bash
      run: |
        set -euo pipefail
        PKG="${{ inputs.package }}"
        echo "Installing formula $PKG (idempotent)..."
        # use NONINTERACTIVE to avoid prompts on Linux
        env NONINTERACTIVE=1 brew install "$PKG" || true

    - name: Export environment for downstream steps
      id: set_env
      shell: bash
      run: |
        set -euo pipefail
        PKG="${{ inputs.package }}"
        BREW_PREFIX="${{ steps.discover_prefix.outputs.brew_prefix }}"
        # fallback if empty
        if [ -z "$BREW_PREFIX" ]; then
          if command -v brew >/dev/null 2>&1; then
            BREW_PREFIX=$(brew --prefix 2>/dev/null || true)
          fi
        fi
        if [ -z "$BREW_PREFIX" ]; then
          echo "Could not determine brew prefix; attempting common locations"
          for p in "/home/linuxbrew/.linuxbrew" "/opt/homebrew" "/usr/local"; do
            if [ -d "$p" ]; then
              BREW_PREFIX="$p"
              break
            fi
          done
        fi

        OPT_DIR=""
        if [ -n "$BREW_PREFIX" ]; then
          OPT_DIR="$BREW_PREFIX/opt/$PKG"
        fi

        # Write PATH, LDFLAGS, CPPFLAGS, PKG_CONFIG_PATH to GITHUB_ENV so subsequent steps pick them up
        if [ -n "$OPT_DIR" ] && [ -d "$OPT_DIR" ]; then
          echo "PATH=$OPT_DIR/bin:\$PATH" >> "$GITHUB_ENV"
          echo "LDFLAGS=-L$OPT_DIR/lib" >> "$GITHUB_ENV"
          echo "CPPFLAGS=-I$OPT_DIR/include" >> "$GITHUB_ENV"
          echo "PKG_CONFIG_PATH=$OPT_DIR/lib/pkgconfig" >> "$GITHUB_ENV"
        else
          # best-effort: if brew is present, use its bin
          if command -v brew >/dev/null 2>&1; then
            BREW_BIN=$(brew --prefix 2>/dev/null)/bin || true
            echo "PATH=$BREW_BIN:\$PATH" >> "$GITHUB_ENV"
          fi
        fi

        # also surface outputs via GITHUB_OUTPUT
        echo "package_prefix=${OPT_DIR}" >> "$GITHUB_OUTPUT"
        echo "brew_prefix=${BREW_PREFIX}" >> "$GITHUB_OUTPUT"

        echo "Exported environment variables for downstream steps"
{
  "name": "homebrew-zoomrecovery",
  "version": "1.0.0",
  "description": "Placeholder package.json â€” not used by composite action",
  "private": true
}